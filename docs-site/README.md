# Universal Numbers Documentation Site

Starlight-based documentation site for the Universal Numbers Library, deployed to GitHub Pages at https://stillwater-sc.github.io/universal/.

## Architecture: Two Sources of Truth

```
SOURCES (committed, edit here)            GENERATED (gitignored, never edit)
──────────────────────────────            ──────────────────────────────────
docs/number-systems/*.md            ──┐
docs/*.md (tutorials, design, etc)    ├─► sync-content.mjs ──► src/content/docs/
repo root (PURPOSE.md, etc)         ──┘   (runs automatically via npm run build/dev)

src/content/docs/                     ◄── Hand-written pages (committed directly)
  getting-started/index.md, installation.md, docker.md, first-program.md
  resources/citation.md, presentations.md
  tutorials/index.md, a-real-with-uncertainty.md
  build/index.md, contributing/index.md, design/index.md
  index.mdx (splash page)
```

## Source vs Generated

| Location | Status | Count | Rule |
|----------|--------|-------|------|
| `docs/number-systems/*.md` | **Source** | 29 | Edit here for number system docs |
| `docs/*.md` (top-level) | **Source** | 16 | Tutorials, mixed-precision, design, build |
| Repo root (`PURPOSE.md`, etc) | **Source** | 4 | Changelog, contributors, code of conduct |
| `src/content/docs/` (hand-written) | **Source** | 11 | Landing pages, getting-started guide, resources |
| `src/content/docs/` (synced dirs) | **Generated** | 53 | Never edit — overwritten on every build |

### Generated directories (gitignored)

These are populated by `sync-content.mjs` from the `docs/` directory. **Never edit files in these directories** — your changes will be lost on the next build:

- `src/content/docs/number-systems/`
- `src/content/docs/mixed-precision/`
- `src/content/docs/tutorials/` (except `index.md` and `a-real-with-uncertainty.md`)
- `src/content/docs/design/` (except `index.md`)
- `src/content/docs/build/` (except `index.md`)
- `src/content/docs/contributing/` (except `index.md`)

### Hand-written pages (committed)

These are authored directly in `src/content/docs/` and are **not** generated by the sync script. They are safe because the sync script only deletes and rewrites files listed in its `FILE_MAP` and `ROOT_FILE_MAP`:

- `index.mdx` — splash page with hero section
- `getting-started/` — `index.md`, `installation.md`, `docker.md`, `first-program.md`
- `resources/` — `citation.md`, `presentations.md`
- `tutorials/index.md`, `tutorials/a-real-with-uncertainty.md`
- `build/index.md`, `contributing/index.md`, `design/index.md`

## What sync-content.mjs Does

The sync script runs automatically before `npm run dev` and `npm run build`. It:

1. **Deletes** all previously synced destination files (listed in `FILE_MAP`/`ROOT_FILE_MAP`) so updated sources are always picked up. Hand-written pages are untouched.
2. Reads each source `.md` file and extracts the `# H1` heading as YAML frontmatter `title:`
3. Rewrites image paths: `](img/...)` to `](/universal/img/...)`
4. Rewrites `.md` links to clean URLs: `](integer.md)` to `](/universal/number-systems/integer/)`
5. Writes the processed file to the destination
6. Copies static assets (`docs/img/`, `docs/closure_plots/`, `docs/presentations/`) to `public/`
7. Clears the Astro cache to ensure changes are detected

## Common Workflows

### Edit an existing number system doc (e.g., dfloat)

```bash
# 1. Edit the source file
vim docs/number-systems/dfloat.md

# 2. Build and preview
cd docs-site
npm run build
npm run preview
```

### Add a new number system doc

```bash
# 1. Create the source file
vim docs/number-systems/newtype.md

# 2. Register in sync-content.mjs FILE_MAP
#    Add: 'number-systems/newtype.md': 'number-systems/newtype.md',

# 3. Add to sidebar in astro.config.mjs
#    Add link in the appropriate Number Systems subcategory

# 4. Build and preview
cd docs-site
npm run build
npm run preview
```

### Edit a hand-written page (getting-started, landing pages, resources)

```bash
# Edit directly — these are not synced
vim docs-site/src/content/docs/getting-started/installation.md

cd docs-site
npm run build
npm run preview
```

### Edit repo-root docs (PURPOSE, CHANGELOG, etc.)

```bash
# Edit at repo root — sync picks them up automatically
vim PURPOSE.md

cd docs-site
npm run build
```

## Gotchas

- **Underscore-to-hyphen renames**: Three files are renamed during sync:
  - `dd_cascade.md` → `dd-cascade.md` (URL: `/number-systems/dd-cascade/`)
  - `td_cascade.md` → `td-cascade.md`
  - `qd_cascade.md` → `qd-cascade.md`
- **Links in source markdown**: Use relative `.md` links (e.g., `[integer](integer.md)`). The sync script rewrites them to Starlight clean URLs automatically. This keeps links working on GitHub too.
- **Hand-written pages are protected**: `syncFile()` checks `existsSync(destPath)` before writing, so hand-written `index.md` landing pages will never be overwritten.
- **Sidebar configuration**: Number Systems sidebar items are manually configured in `astro.config.mjs` for grouping. Other sections use `autogenerate: { directory: '...' }`.

## Development

```bash
npm install        # install dependencies
npm run dev        # sync + start dev server with hot reload
npm run build      # sync + production build
npm run preview    # serve the production build locally
npm run sync       # run sync-content.mjs only (no build)
```
